// Prisma Schema for LetAiCode
// 完整的数据库设计

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ========== 用户表 ==========
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  role      UserRole @default(USER) // 用户角色
  status    Int      @default(1) // 状态（1=启用 0=禁用）
  timezone  String   @default("Asia/Shanghai") // 用户时区
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联
  apiKeys            ApiKey[]
  creditTransactions CreditTransaction[]
  sessions           Session[]
  orders             PaymentOrder[]
  subscription       UserSubscription? // 用户订阅
  creditBalance      UserCreditBalance? // 用户积分余额

  @@map("users")
}

enum UserRole {
  USER  // 普通用户
  ADMIN // 管理员
  ROOT  // 超级管理员
}

// ========== 邮箱验证码表 ==========
model EmailCode {
  id        String   @id @default(uuid())
  email     String
  code      String   // 6位验证码
  expiresAt DateTime // 过期时间（5分钟）
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email, createdAt])
  @@map("email_codes")
}

// ========== API Key 表 ==========
model ApiKey {
  id           String    @id @default(uuid())
  userId       String
  label        String    // Key 名称/备注
  remoteKeyId  String?   // new-api 中的 Key ID
  maskedValue  String    // 脱敏后的 Key 值（sk-****...后4位）
  fullValue    String    @db.VarChar(10000) // 完整 Key 值（加密存储）
  status       KeyStatus @default(ACTIVE)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastUsedAt   DateTime?

  // 关联
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  usageRecords UsageRecord[]

  @@index([userId])
  @@index([remoteKeyId])
  @@map("api_keys")
}

enum KeyStatus {
  ACTIVE
  DISABLED
  DELETED
}

// ========== 使用记录表 ==========
model UsageRecord {
  id               String   @id @default(uuid())
  apiKeyId         String
  timestamp        DateTime @default(now())
  model            String   // 模型名称
  promptTokens     Int      // 提示 tokens
  completionTokens Int      // 完成 tokens
  totalTokens      Int      // 总 tokens
  costUsd          Float    @default(0) // 原始美元金额
  creditCost       Int      // 积分消耗（根据汇率换算）
  rawMeta          String?  @db.VarChar(10000) // 原始元数据（JSON 字符串）

  // 关联
  apiKey ApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId, timestamp])
  @@map("usage_records")
}

// ========== 积分交易表 ==========
model CreditTransaction {
  id        String          @id @default(uuid())
  userId    String
  type      TransactionType
  amount    Int             // 积分数量（正数为充值/赠送，负数为扣除）
  balance   Int             // 交易后余额
  ref       String?         // 关联引用（订单号、使用记录ID等）
  desc      String?         // 描述
  createdAt DateTime        @default(now())

  // 关联
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("credit_transactions")
}

enum TransactionType {
  SUBSCRIPTION  // 订阅开通/续费
  REPLENISH     // 每小时补充
  DAILY_RESET   // 每日重置
  DEDUCT        // API 调用扣除
  ADMIN_ADJUST  // 管理员调整
  RECHARGE      // 充值（保留兼容）
  BONUS         // 赠送（保留兼容）
  REFUND        // 退款（保留兼容）
}

// ========== 用户积分余额表（新增） ==========
model UserCreditBalance {
  id               String    @id @default(uuid())
  userId           String    @unique
  baseCredits      Int       @default(0) // 基础积分（天花板）
  replenishCredits Int       @default(0) // 每小时补充量
  currentCredits   Int       @default(0) // 当前可用积分
  lastReplenishAt  DateTime  @default(now()) // 上次补充时间
  lastDailyResetAt DateTime? // 上次每日重置时间
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // 关联
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_credit_balances")
}

// ========== 用户订阅表（新增） ==========
model UserSubscription {
  id        String             @id @default(uuid())
  userId    String             @unique
  packageId String
  status    SubscriptionStatus @default(ACTIVE)
  startDate DateTime           // 订阅开始时间
  endDate   DateTime           // 订阅结束时间
  autoRenew Boolean            @default(false) // 是否自动续费
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  // 关联
  user    User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  package SubscriptionPackage @relation(fields: [packageId], references: [id])

  @@map("user_subscriptions")
}

enum SubscriptionStatus {
  ACTIVE    // 激活中
  EXPIRED   // 已过期
  CANCELLED // 已取消
}

// ========== 订阅套餐表（新增） ==========
model SubscriptionPackage {
  id               String       @id @default(uuid())
  name             String       // 套餐名称
  cycle            PackageCycle // 周期类型
  cycleDays        Int          // 周期天数（7/30/90/365）
  price            Decimal      @db.Decimal(10, 2) // 价格（元）
  baseCredits      Int          // 基础积分（天花板）
  replenishCredits Int          // 每小时补充积分
  desc             String?      // 描述
  sortOrder        Int          @default(0) // 排序
  active           Boolean      @default(true) // 是否激活
  recommended      Boolean      @default(false) // 是否推荐
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // 关联
  subscriptions UserSubscription[]
  orders        PaymentOrder[]

  @@map("subscription_packages")
}

enum PackageCycle {
  WEEK    // 周
  MONTH   // 月
  QUARTER // 季
  YEAR    // 年
}

// ========== 支付订单表（修改） ==========
model PaymentOrder {
  id            String        @id @default(uuid())
  orderNo       String        @unique // 订单号
  userId        String
  packageId     String
  amount        Decimal       @db.Decimal(10, 2) // 支付金额
  status        PaymentStatus @default(PENDING)
  paymentMethod String?       // 支付方式（wechat/alipay）
  transactionId String?       @db.VarChar(10000) // 第三方交易号
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  expiresAt     DateTime      // 订单过期时间

  // 关联
  user    User                @relation(fields: [userId], references: [id])
  package SubscriptionPackage @relation(fields: [packageId], references: [id])

  @@index([userId, createdAt])
  @@index([orderNo])
  @@map("payment_orders")
}

enum PaymentStatus {
  PENDING   // 待支付
  PAID      // 已支付
  CANCELLED // 已取消
  EXPIRED   // 已过期
  REFUNDED  // 已退款
}

// ========== 会话表 ==========
model Session {
  id           String   @id @default(uuid())
  userId       String
  refreshToken String   @unique @db.VarChar(768)
  expiresAt    DateTime // 14天有效期
  createdAt    DateTime @default(now())

  // 关联
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
  @@map("sessions")
}

// ========== 配置表（系统配置） ==========
model Option {
  key       String   @id // 配置键（主键）
  value     String   @db.VarChar(10000) // 配置值（支持 JSON）
  desc      String?  // 配置描述
  updatedAt DateTime @updatedAt

  @@map("options")
}

// ========== Webhook 日志表 ==========
model WebhookLog {
  id          String   @id @default(uuid())
  eventId     String   @unique // new-api 发送的事件 ID（用于幂等性检查）
  payload     String   @db.LongText // 完整的 webhook 负载（JSON 字符串）
  status      String   @default("processed") // 处理状态（processed/failed）
  errorMsg    String?  // 错误信息
  processedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([eventId])
  @@index([createdAt])
  @@map("webhook_logs")
}
