# å®æ—¶ç§¯åˆ†æ£€æŸ¥æ–¹æ¡ˆè®¾è®¡

**è®¾è®¡æ—¥æœŸ**ï¼š2024-12-18
**ç›®æ ‡**ï¼šå®ç° new-api åœ¨è°ƒç”¨æ¨¡å‹å‰ï¼Œå¯¹ LetAiCode ç”Ÿæˆçš„ key è¿›è¡Œå®æ—¶ç§¯åˆ†æ£€æŸ¥

---

## 1. æ ¸å¿ƒé—®é¢˜

### å½“å‰æ¶æ„çš„é—®é¢˜

```
ç”¨æˆ·é€šè¿‡ LetAiCode ç”Ÿæˆçš„ key è°ƒç”¨ new-api
    â†“
new-api æ£€æŸ¥ users è¡¨çš„ quotaï¼ˆå·²è¿‡æ—¶ï¼ŒåŸºäº 5 åˆ†é’Ÿè½®è¯¢ï¼‰
    â†“
å³ä½¿æœ¬åœ° quota ä¸è¶³ä¹Ÿå¯èƒ½é€šè¿‡ï¼ˆæˆ–è€…é€šè¿‡ä½†å®é™…ä¸å¤Ÿï¼‰
    â†“
âŒ new-api ç›´æ¥è°ƒç”¨ä¸Šæ¸¸æ¨¡å‹
    â†“
âŒ æ¶ˆè€—äº†çœŸå®çš„ tokens
    â†“
webhook å‘é€åˆ° LetAiCode
    â†“
LetAiCode æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
    â”œâ”€ å¦‚æœä¸è¶³ â†’ webhook å¤„ç†å¤±è´¥
    â””â”€ ä½†æ¨¡å‹å·²ç»è¢«è°ƒç”¨è¿‡äº†ï¼ğŸ˜±
```

### è§£å†³ç›®æ ‡

```
ç”¨æˆ·é€šè¿‡ LetAiCode ç”Ÿæˆçš„ key è°ƒç”¨ new-api
    â†“
âœ… new-api è¯†åˆ«å‡ºè¿™æ˜¯ LetAiCode çš„ key
    â†“
âœ… new-api ä¸»åŠ¨æŸ¥è¯¢ LetAiCode è·å–å®æ—¶ç§¯åˆ†
    â†“
âœ… new-api æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
    â”œâ”€ ä¸è¶³ â†’ è¿”å› 403ï¼Œä¸è°ƒç”¨æ¨¡å‹
    â””â”€ è¶³å¤Ÿ â†’ å…è®¸è°ƒç”¨
    â†“
âœ… è°ƒç”¨ä¸Šæ¸¸æ¨¡å‹
    â†“
âœ… webhook é€šçŸ¥ LetAiCode å®é™…æ¶ˆè€—
    â†“
âœ… LetAiCode æ›´æ–°ç§¯åˆ†ï¼ˆä¸€èˆ¬ä¸ä¼šå¤±è´¥ï¼Œå› ä¸ºå·²ç»æå‰éªŒè¯è¿‡ï¼‰
```

---

## 2. æ–¹æ¡ˆè®¾è®¡

### 2.1 æ ¸å¿ƒæ¶æ„

#### ç¬¬ä¸€æ­¥ï¼šæ ‡è®° LetAiCode çš„ key

åœ¨ new-api çš„ tokens è¡¨ä¸­æ·»åŠ æ–°å­—æ®µæ¥æ ‡è®° key çš„æ¥æºï¼š

**æ–¹æ¡ˆ Aï¼šæ·»åŠ  `source` å­—æ®µï¼ˆæ¨èï¼‰**
```sql
ALTER TABLE tokens ADD COLUMN source VARCHAR(50) DEFAULT 'native';
-- source å–å€¼ï¼š
-- 'native'     - new-api æœ¬åœ°åˆ›å»ºçš„ key
-- 'letaicode'  - LetAiCode åˆ›å»ºçš„ key
-- 'external'   - ç¬¬ä¸‰æ–¹åˆ›å»ºçš„ keyï¼ˆæœªæ¥æ‰©å±•ï¼‰
```

**æˆ–æ–¹æ¡ˆ Bï¼šæ·»åŠ  `remote_key_id` å­—æ®µ**
```sql
ALTER TABLE tokens ADD COLUMN remote_key_id INT UNIQUE;
-- å¦‚æœ remote_key_id ä¸ä¸º NULLï¼Œè¯´æ˜æ˜¯ LetAiCode åˆ›å»ºçš„ key
-- å€¼ä¸º LetAiCode ä¾§ api_keys è¡¨çš„ id
```

**æ¨èç”¨æ–¹æ¡ˆ A**ï¼Œç†ç”±ï¼š
- æ›´æ¸…æ™°æ˜ç¡®
- ä¾¿äºæ‰©å±•å…¶ä»–æ¥æº
- æŸ¥è¯¢é€»è¾‘ç®€å•
- ä¾¿äºæ—¥å¿—å’Œç›‘æ§

#### ç¬¬äºŒæ­¥ï¼šLetAiCode åˆ›å»º key æ—¶æ ‡è®°æ¥æº

å½“ LetAiCode åˆ›å»º key å¹¶åŒæ­¥åˆ° new-api æ—¶ï¼Œè®¾ç½® `source = 'letaicode'`ï¼š

```typescript
// LetAiCode åç«¯
POST /api/keys/create â†’ new-api
{
  "key": "sk-xxx...",
  "name": "My API Key",
  "source": "letaicode",           // â† æ ‡è®°æ¥æº
  "remote_key_id": 42              // â† å…³è”å› LetAiCode
}
```

#### ç¬¬ä¸‰æ­¥ï¼šnew-api åœ¨ PreConsumeQuota æ£€æŸ¥

```go
// new-api service/pre_consume_quota.go
func PreConsumeQuota(c *gin.Context, preConsumedQuota int, relayInfo *relaycommon.RelayInfo) *types.NewAPIError {

  // è·å– token ä¿¡æ¯
  token := c.GetString("token")
  tokenSource := c.GetString("token_source")  // â† ä» token ä¿¡æ¯ä¸­è·å–æ¥æº

  // å¦‚æœæ˜¯ LetAiCode çš„ keyï¼Œè¿›è¡Œå®æ—¶æ£€æŸ¥
  if tokenSource == "letaicode" {
    // æ­¥éª¤ 1ï¼šä» token è·å– remoteKeyId
    remoteKeyId := c.GetInt("remote_key_id")

    // æ­¥éª¤ 2ï¼šè°ƒç”¨ LetAiCode API è·å–å®æ—¶ç§¯åˆ†
    credit, err := getLetAiCodeCredit(remoteKeyId)
    if err != nil {
      // å¦‚æœæŸ¥è¯¢å¤±è´¥ï¼Œé™çº§å¤„ç†ï¼ˆè§ 2.2ï¼‰
      return handleLetAiCodeQueryFailure(c, err)
    }

    // æ­¥éª¤ 3ï¼šæ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
    if credit <= 0 {
      return insufficientCredit()
    }

    // æ­¥éª¤ 4ï¼šæ£€æŸ¥æ˜¯å¦è¶³ä»¥é¢„æ‰£è´¹
    if credit - preConsumedQuota < 0 {
      return insufficientCredit()
    }
  } else {
    // é LetAiCode keyï¼Œä½¿ç”¨åŸé€»è¾‘ï¼ˆæ£€æŸ¥ users.quotaï¼‰
    userQuota, err := model.GetUserQuota(relayInfo.UserId, false)
    if err != nil || userQuota <= 0 {
      return insufficientQuota()
    }
  }

  // ç»§ç»­åŸæœ‰çš„ quota æ‰£é™¤é€»è¾‘
  ...
}
```

---

## 3. è¯¦ç»†å®ç°æ­¥éª¤

### 3.1 LetAiCode åç«¯æ”¹åŠ¨

#### Step 1ï¼šAPI ç«¯ç‚¹ - æŸ¥è¯¢ç”¨æˆ·ç§¯åˆ†ï¼ˆnew-api è°ƒç”¨ï¼‰

```typescript
// backend/src/controllers/credit.controller.ts
export class CreditController {
  /**
   * è·å–ç”¨æˆ·ç§¯åˆ†ä½™é¢ï¼ˆä¾› new-api è°ƒç”¨ï¼‰
   * GET /api/credits/balance/:keyId
   * Headers:
   *   - X-API-Key: admin_token
   * Response:
   *   {
   *     "credit": 1000,
   *     "userId": "user-id",
   *     "keyId": 42
   *   }
   */
  async getBalance(req: Request, res: Response) {
    try {
      const { keyId } = req.params;
      const adminToken = req.headers['x-api-key'];

      // 1. éªŒè¯ admin token
      if (adminToken !== process.env.NEW_API_ADMIN_TOKEN) {
        return res.status(401).json({
          success: false,
          message: 'Unauthorized'
        });
      }

      // 2. æ ¹æ® keyId æ‰¾åˆ° API Key
      const apiKey = await prisma.apiKey.findUnique({
        where: { id: keyId },
        include: { user: true }
      });

      if (!apiKey) {
        return res.status(404).json({
          success: false,
          message: 'API Key not found'
        });
      }

      // 3. è·å–ç”¨æˆ·æœ€åä¸€ç¬”äº¤æ˜“è®°å½•çš„ä½™é¢
      const lastTransaction = await prisma.creditTransaction.findFirst({
        where: { userId: apiKey.userId },
        orderBy: { createdAt: 'desc' }
      });

      const credit = lastTransaction?.balance || 0;

      return res.status(200).json({
        success: true,
        credit: credit,
        userId: apiKey.userId,
        keyId: apiKey.id,
        remoteKeyId: apiKey.remoteKeyId,
        timestamp: new Date().toISOString()
      });
    } catch (error) {
      return res.status(500).json({
        success: false,
        message: error.message
      });
    }
  }
}
```

#### Step 2ï¼šæ·»åŠ è·¯ç”±

```typescript
// backend/src/routes/credit.routes.ts
const router = Router();

// è·å–ç”¨æˆ·ä½™é¢ï¼ˆnew-api è°ƒç”¨ï¼‰
router.get('/balance/:keyId', creditController.getBalance.bind(creditController));

export default router;
```

#### Step 3ï¼šåœ¨ä¸»è·¯ç”±æ³¨å†Œ

```typescript
// backend/src/routes/index.ts
import creditRoutes from './credit.routes';

router.use('/credits', creditRoutes);
```

#### Step 4ï¼šåˆ›å»º API Key æ—¶ä¼ é€’æ¥æº

```typescript
// backend/src/services/api-key.service.ts
async createKeyInNewApi(apiKey: any) {
  const response = await fetch(`${process.env.NEW_API_BASE_URL}/api/tokens`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${process.env.NEW_API_ADMIN_TOKEN}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      name: apiKey.label,
      key: apiKey.fullValue,
      source: 'letaicode',           // â† æ ‡è®°æ¥æº
      remote_key_id: apiKey.id,      // â† å…³è” id
      unlimited_quota: false,
      used: false
    })
  });

  return response.json();
}
```

---

### 3.2 new-api åç«¯æ”¹åŠ¨

#### Step 1ï¼šä¿®æ”¹ tokens è¡¨ç»“æ„

```go
// model/token.go
type Token struct {
  ID            int    `gorm:"primaryKey"`
  Name          string
  Key           string
  Source        string `gorm:"default:'native'"` // â† æ–°å¢å­—æ®µ
  RemoteKeyId   int    `gorm:"index"`            // â† æ–°å¢å­—æ®µï¼ˆLetAiCode ä¾§ idï¼‰
  // ... å…¶ä»–å­—æ®µ
}

// æ•°æ®åº“è¿ç§»
// ALTER TABLE tokens ADD COLUMN source VARCHAR(50) DEFAULT 'native';
// ALTER TABLE tokens ADD COLUMN remote_key_id INT;
// CREATE INDEX idx_remote_key_id ON tokens(remote_key_id);
```

#### Step 2ï¼šåˆ›å»º LetAiCode å®¢æˆ·ç«¯

```go
// service/letaicode_client.go
package service

import (
  "encoding/json"
  "fmt"
  "io"
  "net/http"
  "time"

  "github.com/QuantumNous/new-api/common"
  "github.com/QuantumNous/new-api/logger"
  "github.com/gin-gonic/gin"
)

type LetAiCodeCreditResponse struct {
  Success   bool   `json:"success"`
  Credit    int    `json:"credit"`
  UserId    string `json:"userId"`
  KeyId     int    `json:"keyId"`
  Timestamp string `json:"timestamp"`
  Message   string `json:"message"`
}

// GetLetAiCodeCredit ä» LetAiCode è·å–å®æ—¶ç§¯åˆ†
func GetLetAiCodeCredit(c *gin.Context, remoteKeyId int) (int, error) {
  letaicodeDomain := common.GetOption("letaicode_domain", "")
  if letaicodeDomain == "" {
    return 0, fmt.Errorf("letaicode_domain not configured")
  }

  adminToken := common.GetOption("letaicode_admin_token", "")
  if adminToken == "" {
    return 0, fmt.Errorf("letaicode_admin_token not configured")
  }

  url := fmt.Sprintf("%s/api/credits/balance/%d", letaicodeDomain, remoteKeyId)

  req, err := http.NewRequest("GET", url, nil)
  if err != nil {
    return 0, fmt.Errorf("failed to create request: %w", err)
  }

  req.Header.Set("X-API-Key", adminToken)
  req.Header.Set("Content-Type", "application/json")

  client := &http.Client{
    Timeout: 5 * time.Second,  // 5ç§’è¶…æ—¶ï¼Œé¿å…é˜»å¡
  }

  resp, err := client.Do(req)
  if err != nil {
    logger.LogWarn(c, fmt.Sprintf("failed to query LetAiCode credit: %v", err))
    return 0, fmt.Errorf("failed to query LetAiCode: %w", err)
  }
  defer resp.Body.Close()

  body, err := io.ReadAll(resp.Body)
  if err != nil {
    return 0, fmt.Errorf("failed to read response: %w", err)
  }

  var result LetAiCodeCreditResponse
  err = json.Unmarshal(body, &result)
  if err != nil {
    return 0, fmt.Errorf("failed to parse response: %w", err)
  }

  if !result.Success {
    return 0, fmt.Errorf("LetAiCode error: %s", result.Message)
  }

  logger.LogInfo(c, fmt.Sprintf("got credit from LetAiCode: keyId=%d, credit=%d", remoteKeyId, result.Credit))
  return result.Credit, nil
}
```

#### Step 3ï¼šä¿®æ”¹ PreConsumeQuota

```go
// service/pre_consume_quota.go
func PreConsumeQuota(c *gin.Context, preConsumedQuota int, relayInfo *relaycommon.RelayInfo) *types.NewAPIError {
  // è·å– token çš„æ¥æºä¿¡æ¯
  tokenSource := c.GetString("token_source")    // ä» TokenAuth ä¸­é—´ä»¶è®¾ç½®
  remoteKeyId := c.GetInt("remote_key_id")

  var userQuota int
  var err error

  // å¦‚æœæ˜¯ LetAiCode çš„ keyï¼Œè¿›è¡Œå®æ—¶æ£€æŸ¥
  if tokenSource == "letaicode" && remoteKeyId > 0 {
    logger.LogInfo(c, fmt.Sprintf("checking credit from LetAiCode for remoteKeyId=%d", remoteKeyId))

    // ä» LetAiCode è·å–å®æ—¶ç§¯åˆ†
    credit, err := GetLetAiCodeCredit(c, remoteKeyId)
    if err != nil {
      // æŸ¥è¯¢å¤±è´¥çš„é™çº§ç­–ç•¥ï¼šä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„ quota
      logger.LogWarn(c, fmt.Sprintf("failed to get credit from LetAiCode, falling back to local quota: %v", err))

      userQuota, err = model.GetUserQuota(relayInfo.UserId, false)
      if err != nil {
        return types.NewError(err, types.ErrorCodeQueryDataError, types.ErrOptionWithSkipRetry())
      }
    } else {
      userQuota = credit
    }
  } else {
    // é LetAiCode keyï¼Œä½¿ç”¨åŸé€»è¾‘
    userQuota, err = model.GetUserQuota(relayInfo.UserId, false)
    if err != nil {
      return types.NewError(err, types.ErrorCodeQueryDataError, types.ErrOptionWithSkipRetry())
    }
  }

  // åç»­é€»è¾‘ä¿æŒä¸å˜
  if userQuota <= 0 {
    return types.NewErrorWithStatusCode(
      fmt.Errorf("user quota insufficient, remaining: %s", logger.FormatQuota(userQuota)),
      types.ErrorCodeInsufficientUserQuota,
      http.StatusForbidden,
      types.ErrOptionWithSkipRetry(),
      types.ErrOptionWithNoRecordErrorLog())
  }

  if userQuota-preConsumedQuota < 0 {
    return types.NewErrorWithStatusCode(
      fmt.Errorf("pre-consume quota failed, remaining: %s, need: %s",
        logger.FormatQuota(userQuota), logger.FormatQuota(preConsumedQuota)),
      types.ErrorCodeInsufficientUserQuota,
      http.StatusForbidden,
      types.ErrOptionWithSkipRetry(),
      types.ErrOptionWithNoRecordErrorLog())
  }

  // ... ç»§ç»­åŸæœ‰é€»è¾‘ ...
  relayInfo.UserQuota = userQuota
  // ... åç»­ä»£ç  ...
}
```

#### Step 4ï¼šä¿®æ”¹ TokenAuth ä¸­é—´ä»¶

```go
// relay/auth/token_auth.go
func TokenAuth(c *gin.Context) {
  // ... ç°æœ‰çš„ token éªŒè¯é€»è¾‘ ...

  token := ... // è·å– token å¯¹è±¡

  // â† æ–°å¢ä»£ç ï¼šè®¾ç½® token çš„æ¥æºä¿¡æ¯
  c.Set("token_source", token.Source)      // 'letaicode' æˆ– 'native'
  c.Set("remote_key_id", token.RemoteKeyId) // LetAiCode ä¾§ id

  // ... ç»§ç»­åŸæœ‰é€»è¾‘ ...
}
```

---

## 4. é…ç½®é¡¹

éœ€è¦åœ¨ new-api ç³»ç»Ÿé€‰é¡¹ä¸­æ·»åŠ ï¼š

| é”® | å€¼ç¤ºä¾‹ | è¯´æ˜ |
|-----|--------|------|
| `letaicode_domain` | `https://letaicode.com` | LetAiCode åŸŸå |
| `letaicode_admin_token` | `sk-admin-xxx` | LetAiCode ç®¡ç†å‘˜ tokenï¼ˆç”¨äºè°ƒç”¨ APIï¼‰ |

**security æ³¨æ„**ï¼šè¿™ä¸ª token åº”è¯¥æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ã€æƒé™å—é™çš„ tokenï¼Œåªå…è®¸æŸ¥è¯¢ç§¯åˆ†ã€‚

---

## 5. å·¥ä½œæµç¨‹ç¤ºæ„

### åœºæ™¯ 1ï¼šLetAiCode ç”¨æˆ·è°ƒç”¨ APIï¼ˆæ–°æµç¨‹ï¼‰

```
ç”¨æˆ·è¯·æ±‚
    â†“
TokenAuth ä¸­é—´ä»¶
â”œâ”€ éªŒè¯ token
â”œâ”€ è¯†åˆ« token æ¥è‡ª LetAiCodeï¼ˆsource='letaicode'ï¼‰
â””â”€ è®¾ç½® c.Set("token_source", "letaicode")
    â†“
PreConsumeQuota
â”œâ”€ å‘ç° tokenSource == "letaicode"
â”œâ”€ è°ƒç”¨ GetLetAiCodeCredit(remoteKeyId)
â”‚  â””â”€ GET /api/credits/balance/42 åˆ° LetAiCode
â”‚     â””â”€ è¿”å›å®æ—¶ç§¯åˆ†ï¼š1000
â”œâ”€ æ£€æŸ¥ 1000 > 100ï¼ˆé¢„æ‰£è´¹é¢åº¦ï¼‰âœ…
â””â”€ å…è®¸è°ƒç”¨
    â†“
è°ƒç”¨ä¸Šæ¸¸æ¨¡å‹
    â†“
RecordConsumeLog
â”œâ”€ è®°å½•ä½¿ç”¨
â”œâ”€ å‘é€ webhook åˆ° LetAiCode
â”‚  â””â”€ eventId: xxx, creditCost: 50
â””â”€ LetAiCode å¤„ç† webhook
    â”œâ”€ ç§¯åˆ†ï¼š1000 - 50 = 950
    â””â”€ webhook_logs è®°å½•ä¸ºæˆåŠŸ
```

### åœºæ™¯ 2ï¼šnative key è°ƒç”¨ APIï¼ˆåŸæµç¨‹ï¼‰

```
ç”¨æˆ·è¯·æ±‚
    â†“
TokenAuth ä¸­é—´ä»¶
â”œâ”€ éªŒè¯ token
â”œâ”€ è¯†åˆ« token æ˜¯ nativeï¼ˆsource='native'ï¼‰
â””â”€ è®¾ç½® c.Set("token_source", "native")
    â†“
PreConsumeQuota
â”œâ”€ å‘ç° tokenSource != "letaicode"
â”œâ”€ ä½¿ç”¨åŸé€»è¾‘ï¼šGetUserQuota()
â”‚  â””â”€ æŸ¥è¯¢ users.quota
â””â”€ ç»§ç»­åŸæœ‰æµç¨‹
    â†“
... åç»­é€»è¾‘ä¸å˜ ...
```

### åœºæ™¯ 3ï¼šLetAiCode æŸ¥è¯¢å¤±è´¥æ—¶çš„é™çº§

```
GetLetAiCodeCredit æŸ¥è¯¢ LetAiCode å¤±è´¥
    â†“
æ•è·é”™è¯¯
    â†“
é™çº§ç­–ç•¥ï¼šä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„ users.quota
    â”œâ”€ è®°å½•è­¦å‘Šæ—¥å¿—
    â””â”€ ç»§ç»­ä½¿ç”¨æœ¬åœ° quota è¿›è¡Œæ£€æŸ¥
    â†“
âœ… ç³»ç»Ÿä¸ä¼šä¸­æ–­ï¼ˆé«˜å¯ç”¨ï¼‰
```

---

## 6. ä¼˜ç‚¹å’Œé£é™©è¯„ä¼°

### ä¼˜ç‚¹ âœ…

1. **å®æ—¶ç§¯åˆ†æ£€æŸ¥**ï¼šåœ¨è°ƒç”¨æ¨¡å‹å‰å°±éªŒè¯ç§¯åˆ†ï¼Œé¿å…é€æ”¯
2. **åŒºåˆ†å¯¹å¾…**ï¼šåªæœ‰ LetAiCode çš„ key æ‰è¿›è¡Œé¢å¤–æ£€æŸ¥ï¼Œnative key ä¸å—å½±å“
3. **é™çº§æ–¹æ¡ˆ**ï¼šå¦‚æœ LetAiCode å®•æœºï¼Œè‡ªåŠ¨é™çº§åˆ°æœ¬åœ°ç¼“å­˜ï¼Œç³»ç»Ÿä¸ä¸­æ–­
4. **æ¶æ„æ¸…æ™°**ï¼šé€šè¿‡ `source` å­—æ®µæ˜ç¡®æ ‡è®° key æ¥æºï¼Œä¾¿äºæ‰©å±•

### é£é™©å’Œç¼“è§£ âš ï¸

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| LetAiCode æŸ¥è¯¢æ…¢ | API å“åº”å»¶è¿Ÿ | 5ç§’è¶…æ—¶ + å¼‚æ­¥ç¼“å­˜æ›´æ–° |
| LetAiCode å®•æœº | æ— æ³•æŸ¥è¯¢ç§¯åˆ† | é™çº§åˆ°æœ¬åœ°ç¼“å­˜ï¼Œç»§ç»­æœåŠ¡ |
| ç§¯åˆ†æ¼‚ç§» | å¯èƒ½æœ‰çŸ­æ—¶å»¶è¿Ÿ | æ¥å—å°èŒƒå›´æ¼‚ç§»ï¼ˆæ¯”è½®è¯¢å¥½å¾ˆå¤šï¼‰ |
| ç½‘ç»œæŠ–åŠ¨ | æŸ¥è¯¢å¤±è´¥ | 1 æ¬¡é‡è¯• + é™çº§ |

---

## 7. æ•°æ®åº“è¿ç§»è„šæœ¬

```sql
-- new-api æ•°æ®åº“
ALTER TABLE tokens ADD COLUMN source VARCHAR(50) DEFAULT 'native';
ALTER TABLE tokens ADD COLUMN remote_key_id INT;
CREATE INDEX idx_tokens_source ON tokens(source);
CREATE INDEX idx_tokens_remote_key_id ON tokens(remote_key_id);

-- æ›´æ–°ç°æœ‰çš„ LetAiCode tokens
UPDATE tokens SET source = 'letaicode' WHERE user_id = 0;
-- ï¼ˆå‡è®¾ LetAiCode çš„ tokens éƒ½æ˜¯ user_id = 0ï¼‰
```

---

## 8. ç¯å¢ƒé…ç½®

### LetAiCode (.env)

```bash
NEW_API_ADMIN_TOKEN=sk-admin-xxx-min-32-chars
```

### new-api (ç³»ç»Ÿé€‰é¡¹)

```
letaicode_domain        = https://your-letaicode.com
letaicode_admin_token   = sk-admin-xxx-min-32-chars
```

âš ï¸ **å®‰å…¨**ï¼šè¿™ä¸ª token åº”è¯¥æ˜¯åªè¯»çš„ã€æƒé™å—é™çš„ã€‚

---

## 9. å®ç°é¡ºåº

1. **ç¬¬ä¸€æ­¥**ï¼šnew-api æ·»åŠ  tokens è¡¨å­—æ®µï¼ˆsource, remote_key_idï¼‰
2. **ç¬¬äºŒæ­¥**ï¼šnew-api åˆ›å»º LetAiCode å®¢æˆ·ç«¯ï¼ˆletaicode_client.goï¼‰
3. **ç¬¬ä¸‰æ­¥**ï¼šnew-api ä¿®æ”¹ PreConsumeQuota å’Œ TokenAuth
4. **ç¬¬å››æ­¥**ï¼šLetAiCode æ·»åŠ ç§¯åˆ†æŸ¥è¯¢ API ç«¯ç‚¹
5. **ç¬¬äº”æ­¥**ï¼šLetAiCode åˆ›å»º key æ—¶è®¾ç½® source å­—æ®µ
6. **ç¬¬å…­æ­¥**ï¼šé…ç½®ç³»ç»Ÿé€‰é¡¹å¹¶æµ‹è¯•

---

## 10. æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

```go
// æµ‹è¯• 1ï¼šLetAiCode ç§¯åˆ†å……è¶³
func TestGetLetAiCodeCreditSufficient(t *testing.T) {
  credit := 1000
  // æ¨¡æ‹Ÿ LetAiCode è¿”å›
  // é¢„æœŸï¼šPreConsumeQuota é€šè¿‡
}

// æµ‹è¯• 2ï¼šLetAiCode ç§¯åˆ†ä¸è¶³
func TestGetLetAiCodeCreditInsufficient(t *testing.T) {
  credit := 0
  // æ¨¡æ‹Ÿ LetAiCode è¿”å›
  // é¢„æœŸï¼šPreConsumeQuota è¿”å› 403
}

// æµ‹è¯• 3ï¼šLetAiCode æŸ¥è¯¢å¤±è´¥ï¼Œé™çº§åˆ°æœ¬åœ°
func TestGetLetAiCodeCreditFallback(t *testing.T) {
  // æ¨¡æ‹ŸæŸ¥è¯¢å¤±è´¥
  // é¢„æœŸï¼šä½¿ç”¨æœ¬åœ° users.quota ç»§ç»­
}
```

### é›†æˆæµ‹è¯•

```bash
1. åˆ›å»º LetAiCode keyï¼ˆsource='letaicode'ï¼‰
2. LetAiCode ä¸ºç”¨æˆ·å……å€¼ 100 ç§¯åˆ†
3. é€šè¿‡ key è°ƒç”¨ APIï¼ˆé¢„ä¼°æ¶ˆè€— 50ï¼‰
4. éªŒè¯ç§¯åˆ†è¢«æ­£ç¡®æ‰£é™¤
5. å†æ¬¡è°ƒç”¨ï¼ˆé¢„ä¼°æ¶ˆè€— 60ï¼‰
6. éªŒè¯è¿”å› 403ï¼ˆç§¯åˆ†ä¸è¶³ï¼‰
```

---

## æ€»ç»“

è¿™ä¸ªæ–¹æ¡ˆçš„æ ¸å¿ƒæ˜¯ï¼š

1. **æ ‡è®°**ï¼šç”¨ `source` å­—æ®µåŒºåˆ† LetAiCode key
2. **æŸ¥è¯¢**ï¼šPreConsumeQuota å¯¹ LetAiCode key è¿›è¡Œå®æ—¶æŸ¥è¯¢
3. **é™çº§**ï¼šæŸ¥è¯¢å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°æœ¬åœ°ç¼“å­˜
4. **éš”ç¦»**ï¼šnative key å®Œå…¨ä¸å—å½±å“

**ä¼˜åŠ¿**ï¼š
- å®æ—¶æ€§å¥½ï¼ˆè§£å†³é€æ”¯é—®é¢˜ï¼‰
- é«˜å¯ç”¨ï¼ˆé™çº§æœºåˆ¶ï¼‰
- æ— ä¾µå…¥ï¼ˆnative key é€»è¾‘ä¸å˜ï¼‰

æ‚¨è§‰å¾—è¿™ä¸ªæ–¹æ¡ˆå¦‚ä½•ï¼Ÿæœ‰éœ€è¦è°ƒæ•´çš„åœ°æ–¹å—ï¼Ÿ
